<!-- src/app/features/dashboard/pages/posts/posts.component.html -->
<div class="min-h-screen bg-gray-50">
  <!-- Header -->
  <div class="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">üìù Posts Management</h1>
          <p class="mt-1 text-sm text-gray-600">
            Manage your blog posts - Total: {{ totalData() }} posts
          </p>
        </div>
        <button
          (click)="createPost()"
          class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 shadow-md hover:shadow-lg"
          type="button"
        >
          <span class="text-xl">‚ûï</span>
          Create New Post
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Filters Section -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Search -->
        <div>
          <label for="search" class="block text-sm font-medium text-gray-700 mb-2">üîç Search</label>
          <input
            id="search"
            type="text"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="Search by title..."
            [value]="searchQuery()"
            (input)="searchQuery.set($any($event.target).value)"
          />
        </div>

        <!-- Status Filter -->
        <div>
          <label for="status" class="block text-sm font-medium text-gray-700 mb-2">üìä Status</label>
          <select
            id="status"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            [value]="selectedStatus()"
            (change)="selectedStatus.set($any($event.target).value)"
          >
            <option value="">All Status</option>
            <option value="draft">Draft</option>
            <option value="published">Published</option>
            <option value="archived">Archived</option>
          </select>
        </div>

        <!-- Category Filter -->
        <div>
          <label for="category" class="block text-sm font-medium text-gray-700 mb-2"
            >üìÅ Category</label
          >
          <select
            id="category"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            [value]="selectedCategory()"
            (change)="selectedCategory.set($any($event.target).value)"
          >
            <option value="">All Categories</option>
            @for (cat of categories(); track cat.id) {
            <option [value]="cat.id">{{ cat.name }}</option>
            }
          </select>
        </div>

        <!-- Sort -->
        <div>
          <label for="sort" class="block text-sm font-medium text-gray-700 mb-2">üîÑ Sort By</label>
          <div class="flex gap-2">
            <select
              id="sort"
              class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              [value]="sortBy()"
              (change)="sortBy.set($any($event.target).value)"
            >
              <option value="created_at">Created Date</option>
              <option value="updated_at">Updated Date</option>
              <option value="title">Title</option>
              <option value="views">Views</option>
            </select>
            <button
              (click)="sortOrder.set(sortOrder() === 'asc' ? 'desc' : 'asc')"
              class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
              type="button"
              [title]="sortOrder() === 'asc' ? 'Ascending' : 'Descending'"
            >
              {{ sortOrder() === 'asc' ? '‚Üë' : '‚Üì' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Clear Filters -->
      <div class="mt-4 flex justify-end">
        <button
          (click)="clearFilters()"
          class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
          type="button"
        >
          ‚úñÔ∏è Clear Filters
        </button>
      </div>
    </div>

    <!-- Posts Table with @defer -->
    @defer (when !isLoading()) {
    <!-- Error State -->
    @if (error()) {
    <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
      <div class="flex items-center gap-3">
        <span class="text-3xl">‚ö†Ô∏è</span>
        <div>
          <h3 class="text-lg font-semibold text-red-800">Error Loading Posts</h3>
          <p class="text-red-600 mt-1">{{ error() }}</p>
          <button
            (click)="loadPosts({ page: currentPage(), limit: 10 })"
            class="mt-3 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
            type="button"
          >
            Retry
          </button>
        </div>
      </div>
    </div>
    }

    <!-- Empty State -->
    @if (!error() && posts().length === 0) {
    <div class="bg-white rounded-lg shadow-sm p-12 text-center">
      <span class="text-6xl mb-4 block">üìÑ</span>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">No Posts Found</h3>
      <p class="text-gray-600 mb-6">
        @if (searchQuery() || selectedStatus() || selectedCategory()) { No posts match your filters.
        Try adjusting them. } @else { Get started by creating your first post! }
      </p>
      <button
        (click)="createPost()"
        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors inline-flex items-center gap-2"
        type="button"
      >
        <span>‚ûï</span>
        Create First Post
      </button>
    </div>
    }

    <!-- Posts Table -->
    @if (!error() && posts().length > 0) {
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Title
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Category
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Status
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Views
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Date
              </th>
              <th
                class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            @for (post of posts(); track post.id) {
            <!-- ‚úÖ @defer per row untuk optimasi -->
            @defer (on viewport; prefetch on idle) {
            <tr class="hover:bg-gray-50 transition-colors">
              <!-- Title -->
              <td class="px-6 py-4">
                <div class="flex items-start gap-3">
                  @if (post.featured_image) {
                  <img
                    [src]="post.featured_image"
                    [alt]="post.title"
                    class="w-16 h-16 rounded-lg object-cover shrink-0"
                  />
                  }
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate" [title]="post.title">
                      {{ post.title }}
                    </p>
                    <p class="text-xs text-gray-500 mt-1">By {{ post.author.full_name }}</p>
                    @if (post.tags && post.tags.length > 0) {
                    <div class="flex flex-wrap gap-1 mt-2">
                      @for (tag of post.tags.slice(0, 3); track tag) {
                      <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">
                        {{ tag }}
                      </span>
                      } @if (post.tags.length > 3) {
                      <span class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded">
                        +{{ post.tags.length - 3 }}
                      </span>
                      }
                    </div>
                    }
                  </div>
                </div>
              </td>

              <!-- Category -->
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-sm text-gray-900">{{ post.category.name }}</span>
              </td>

              <!-- Status -->
              <td class="px-6 py-4 whitespace-nowrap">
                <span
                  class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                  [ngClass]="getStatusBadgeClass(post.status)"
                >
                  {{ post.status }}
                </span>
              </td>

              <!-- Views -->
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">üëÅÔ∏è {{ post.views }}</td>

              <!-- Date -->
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {{ formatDate(post.created_at) }}
              </td>

              <!-- Actions -->
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex justify-end gap-2">
                  <!-- View -->
                  <button
                    (click)="viewPost(post.slug)"
                    class="text-blue-600 hover:text-blue-900 transition-colors"
                    title="View Post"
                    type="button"
                  >
                    üëÅÔ∏è
                  </button>

                  <!-- Edit -->
                  @if (canEditPost(post)) {
                  <button
                    (click)="editPost(post.id)"
                    class="text-indigo-600 hover:text-indigo-900 transition-colors"
                    title="Edit Post"
                    type="button"
                  >
                    ‚úèÔ∏è
                  </button>
                  }

                  <!-- Publish/Unpublish (Admin only) -->
                  @if (canPublishPost()) { @if (post.status === 'published') {
                  <button
                    (click)="unpublishPost(post)"
                    class="text-yellow-600 hover:text-yellow-900 transition-colors"
                    title="Unpublish Post"
                    type="button"
                  >
                    üì§
                  </button>
                  } @else {
                  <button
                    (click)="publishPost(post)"
                    class="text-green-600 hover:text-green-900 transition-colors"
                    title="Publish Post"
                    type="button"
                  >
                    ‚úÖ
                  </button>
                  } }

                  <!-- Delete -->
                  @if (canDeletePost(post)) {
                  <button
                    (click)="openDeleteModal(post)"
                    class="text-red-600 hover:text-red-900 transition-colors"
                    title="Delete Post"
                    type="button"
                  >
                    üóëÔ∏è
                  </button>
                  }
                </div>
              </td>
            </tr>
            } @placeholder {
            <!-- Placeholder before viewport -->
            <tr class="animate-pulse">
              <td colspan="6" class="px-6 py-4">
                <div class="h-16 bg-gray-100 rounded"></div>
              </td>
            </tr>
            } @loading (minimum 300ms) {
            <!-- Loading skeleton -->
            <tr class="animate-pulse">
              <td colspan="6" class="px-6 py-4">
                <div class="h-16 bg-gray-200 rounded"></div>
              </td>
            </tr>
            } }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      @if (totalPages() > 1) {
      <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-700">
            Showing page <strong>{{ currentPage() }}</strong> of
            <strong>{{ totalPages() }}</strong>
          </div>
          <div class="flex gap-2">
            <button
              (click)="previousPage()"
              [disabled]="currentPage() === 1"
              class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              type="button"
            >
              ‚Üê Previous
            </button>
            <button
              (click)="nextPage()"
              [disabled]="currentPage() === totalPages()"
              class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              type="button"
            >
              Next ‚Üí
            </button>
          </div>
        </div>
      </div>
      }
    </div>
    } } @placeholder {
    <!-- Initial placeholder -->
    <div class="bg-white rounded-lg shadow-sm p-12 text-center">
      <div class="animate-spin text-6xl mb-4">‚è≥</div>
      <p class="text-gray-500">Loading posts...</p>
    </div>
    } @loading (minimum 800ms) {
    <!-- Loading skeleton with animation -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
      <div class="animate-pulse space-y-4 p-6">
        @for (i of [1,2,3,4,5]; track i) {
        <div class="flex gap-4">
          <div class="w-16 h-16 bg-gray-200 rounded-lg"></div>
          <div class="flex-1 space-y-2">
            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
          </div>
        </div>
        }
      </div>
    </div>
    }
  </div>
</div>

<!-- Delete Confirmation Modal -->
@if (deleteModalOpen()) {
<div
  class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"
  (click)="closeDeleteModal()"
>
  <div class="bg-white rounded-xl max-w-md w-full shadow-2xl" (click)="$event.stopPropagation()">
    <div class="p-6">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-4xl">‚ö†Ô∏è</span>
        <h3 class="text-xl font-bold text-gray-900">Delete Post?</h3>
      </div>
      <p class="text-gray-600 mb-6">
        Are you sure you want to delete
        <strong>"{{ postToDelete()?.title }}"</strong>? This action cannot be undone.
      </p>
      <div class="flex gap-3">
        <button
          (click)="closeDeleteModal()"
          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
          type="button"
        >
          Cancel
        </button>
        <button
          (click)="confirmDelete()"
          class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
          type="button"
        >
          Delete
        </button>
      </div>
    </div>
  </div>
</div>
}
